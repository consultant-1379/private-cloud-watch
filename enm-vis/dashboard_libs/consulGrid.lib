{{ define "console_grid_js" }}
var aspectRatio = 4.0/3.0; // asotv (old style)
//var aspectRatio = 16.0/9.0; // asotv (new style)
//var aspectRatio = 1.0;
var cellSize = 12;

var MemberStatus = [ "Missing", "Alive", "Leaving", "Left", "Failed" ];
var fillColors = [ "#ffffff", "#00ff00", "#ffff00", "#0000ff", "#ff0000" ];

function gridInit(nrows, ncols, inp, width, height) {
    var data = new Array();

    for (var row = 0; row < nrows && data.length < inp.length; row++) {
        for (var col = 0; col < ncols && data.length < inp.length; col++) {
            d = inp[data.length]
            data.push({
                x: col*width+1, // border for stroke
                y: row*height+1,
                width: width,
                height: height,
                name: d.metric.name,
                state: d.value[1]
            })
        }
    }
    return { width: ncols*width+2, height: nrows*height+2, cells: data };
}

function makeGrid(id, data) {
    if (data.length == 0) {
        var d = { metric: { name: 'no data' }, value: [ 0, 0 ] };
        data = [ d ];
    }
    var nCells = data.length;
    var nCols = Math.round(Math.sqrt(aspectRatio*nCells));
    var nRows = Math.floor(nCells/nCols);
    if (nCols*nRows < nCells) nRows++;

    var cellData = gridInit(nRows, nCols, data, cellSize, cellSize);

    var grid = d3.select(id)
        .append("svg")
        .attr("width", cellData.width+"px")
        .attr("height", cellData.height+"px");

    var cell = grid.selectAll(".cell")
        .data(cellData.cells)
        .enter().append("rect")
        .attr("x", function(d) { return d.x; })
        .attr("y", function(d) { return d.y; })
        .attr("width", function(d) { return d.width; })
        .attr("height", function(d) { return d.height; })
        .style("fill", function(d) {
		if (d.state >= 0 && d.state < fillColors.length) {
			return fillColors[d.state];
		}
		return "#1f1f1f";
	})
        .style("stroke", "#222")
        .append('svg:title')
        .text(function(d) {
		var s = d.name + ' : ' + d.state;
		if (d.state >= 0 && d.state < MemberStatus.length) {
         		s += ": " + MemberStatus[d.state];
		}
		return s;
	});
}
{{ end }}
