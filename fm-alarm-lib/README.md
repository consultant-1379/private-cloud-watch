# FM Alarm shared library

> This project is in python 2.7 because that's the python version available on EMP server.  

The goal of this library is to have a point of entry for monitoring scripts to raise and clear FM alarms. It keeps state in consul and rate limits alarms to prevent alarm storms to FM. 
##Usage
```bash
usage: fm_alarm_library.py [-h] [-f CONFIG_FILE] [-s SEVERITY]
                           [-r RECORD_TYPE] [-p SPECIFIC_PROBLEM]
                           [-c PROBABLE_CAUSE] [-e EVENT_TYPE]
                           [-m MANAGED_OBJECT_INSTANCE]
                           [-a ADDITIONAL_ATTRIBUTES]

optional arguments:
  -h, --help            show this help message and exit
  -f CONFIG_FILE, --config-file CONFIG_FILE
                        Config file path. (Default: ./alarm.conf)
  -s SEVERITY, --severity SEVERITY
                        Alarm severity
                        (INDETERMINATE/CRITICAL/MAJOR/MINOR/WARNING/CLEARED),
                        (Default: INDETERMINATE)
  -r RECORD_TYPE, --record-type RECORD_TYPE
                        Record type for internal alarm request
                        (ALARM/NON_SYNCHABLE_ALARM/ERROR_MESSAGE), (Default:
                        ERROR_MESSAGE)
  -p SPECIFIC_PROBLEM, --specific-problem SPECIFIC_PROBLEM
                        This attribute is used to give a further refinement to
                        the cause of the alarm in Text.
  -c PROBABLE_CAUSE, --probable-cause PROBABLE_CAUSE
                        This attribute should give a hint of the general
                        problem causing the alarm.
  -e EVENT_TYPE, --event-type EVENT_TYPE
                        This attribute is used to give cause of raising an
                        alarm.
  -m MANAGED_OBJECT_INSTANCE, --managed-object-instance MANAGED_OBJECT_INSTANCE
                        This attribute specifies the service name raising
                        internal alarm.
  -a ADDITIONAL_ATTRIBUTES, --additional-attributes ADDITIONAL_ATTRIBUTES
                        Optional attributes to raise internal alarms (JSON
                        format).
```

##Installation
###Using venv
Install venv:
```bash
python -m virtualenv venv
```
Activate venv:
```bash
source ./venv/bin/activate
```
Install dependencies:
```bash
pip install -r requirements.txt
```
###Offline Install
>Follow this for an offline install on a server like EMP. If there is internet available, It is recommended to use the venv method described above.

* Download wheels for offline install
```bash
dl_wheels.sh
```
This will download all the required packages as well as a pip package into a folder called `wheels`. 
>This step needs to happen on the same architecture/OS machine as the final install location.

>Windows != Debian != RHEL != SUSE. 
>
Distros based on another is fine. For example wheels downloaded on ubuntu should be okay for install on debian, and wheels downloaded on centos should be okay to install on RHEL.

* Package the application
```bash
create_tar.sh
```
This is create a tar archive with all the required files and dependencies.
* Transfer to install destination and untar
```bash
mkdir fm_alarm_lib; tar -xvzf fm_alarm_lib-v0.1.tar.gz -C fm_alarm_lib
```  
This is extract the files in the the newly created fodler called fm_alarm_lib
* Install wheels
```bash
sudo install.sh
```
EMP or scripting cluster does not have PIP installed. This script will install pip, the needed dependencies, the actual module, and create a config file in `/usr/local/etc/fmalarm/alarm.conf` with default values. 

It is installed for all users, and can be called with `fm-alarm-lib`

## Sample Config File
```bash
[enm]
haproxyIntIp = <HAPROXY_IP>
haproxyPort = 8081

[consul]
url = servicereg-1
port = 8500
folder = alarms

[alarm]
alarmThreshold = 300
```
Default config file is placed in `/usr/local/etc/fmalarm/alarm.conf`. This is auto generated by the install.sh script. 

This can be overridden by using the config flag  `-f CONFIG_FILE, --config-file CONFIG_FILE` when calling the program.

1. haproxyIntIp = internal HA proxy IP for FM.
2. consul.url = Service registry Url.
3. consul.folder = consul KV folder name to save alarms in.
4. alarmThreshold = Time delta between recurring alarms to FM
## Logic Flow
```
+----------------+                    +-------------+                   +----------------+
|                |                    |             |     Alarm Raised  |                |
| Calling Script +------------------->+  Alarm Lib  +------------------>+  Check Consul  |
|                |                    |             |                   |                |
+----------------+                    +--+----------+                   +--------+-------+
                                         |                             Doesn't   |   Entry Exists
                                         | Alarm Cleared               Exist     |
                                         |                             +---------+---------------+
                                         |                             |                         |
                                         v                             |                         |
                                  +------+---------+         +---------v----+         +----------v-----------+
                                  |                |         | Raise alarm  |         |  Check if alarm last |
                  +---------------+  Check Consul  |         | on FM and    |  No     |  raised within       |
                  |  Entry exists |                |         | create consul<---------+  time threshold      |
                  |               +--------+-------+         | Entry        |         |                      |
                  |                        |                 +--------------+         +--------+-------------+
                  |                        |                                                   |
                  |                        |                                                   | Yes.
           +------v-------------+          |                                                   | Do nothing and exit
           |                    |          | Doesn't Exist,                                    |
           |  Clear alarm on FM |          | no need to clear.                                 |
           |  and delete consul |          |                                                   |
           |  entry.            |          |                                                   |
           +-----+--------------+          |                                                   |
                 |                +--------v------+                                            |
                 |                |               |                                            |
                 |                |   Exit        |                                            |
                 +--------------->+               +<-------------------------------------------+
                                  |               |
                                  +---------------+

```
