<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>enmscout-manual</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__left">
    <div class="stackedit__toc">
      
<ul>
<li><a href="#enmscout-the-enm-scout">enmscout: The ENM Scout</a>
<ul>
<li><a href="#what-is-the-purpose-of-enm-scout">What is the purpose of ENM Scout?</a></li>
<li><a href="#what-does-enm-scout-provide">What does ENM Scout provide?</a></li>
<li><a href="#whats-an-ha-event">What’s an “HA event”?</a></li>
<li><a href="#what-causes-the-ha-workflow-to-fire">What causes the HA workflow to fire?</a></li>
<li><a href="#what-are-the-limitations-of-the-ha-workflow">What are the limitations of the HA workflow?</a></li>
<li><a href="#what-are-the-steps-taken-by-an-ha-workflow">What are the steps taken by an HA workflow?</a></li>
<li><a href="#what-does-an-ha-event-look-like">What does an HA event look like?</a></li>
<li><a href="#whats-a-consul-event">What’s a “Consul event”?</a></li>
<li><a href="#what-does-a-consul-event-look-like">What does a Consul event look like?</a></li>
<li><a href="#what-are-the-limitations-of-consul-events">What are the limitations of Consul events?</a></li>
<li><a href="#what-are-the-components-of-enm-scout">What are the components of ENM Scout?</a></li>
<li><a href="#how-can-enm-scout-be-installed">How can ENM Scout be installed?</a></li>
<li><a href="#what-are-the-current-known-caveats">What are the current known caveats?</a></li>
<li><a href="#where-can-i-go-for-more-information">Where can I go for more information?</a></li>
</ul>
</li>
</ul>

    </div>
  </div>
  <div class="stackedit__right">
    <div class="stackedit__html">
      <h1 id="enmscout-the-enm-scout">enmscout: The ENM Scout</h1>
<p>Written by Loren Jan Wilson and Dan Barrett, 2019</p>
<h2 id="what-is-the-purpose-of-enm-scout">What is the purpose of ENM Scout?</h2>
<p>We have some number of ENM deployments running in the same cloud, which presents a few basic challenges:</p>
<ol>
<li>Real-time visibility into the health of the application is low.</li>
<li>We don’t have a single place to look to see what’s happening across the whole cluster.</li>
</ol>
<p>The <strong>enm-viz</strong> ENM visualizer is designed to help with these problems, but its focus is on visualization, and it doesn’t provide text reports that could be sent to customers or further analyzed using other tools. It also uses Consul data exclusively as its data source.</p>
<p>In order to further assist troubleshooting efforts, <strong>enmscout</strong> provides multiple text-based views, and much like enm-viz, it does so in near real-time. Some of the data generated by enmscout is designed to be used as data inputs by other tools, so it’s meant to be kind of a “middle point” between the deployments and the investigators.</p>
<p>ENM Scout uses data sourced from the VNF-LAF jBoss logs, specifically the HA workflow events, as well as the Consul state data. This can serve as a useful alternate data source to what’s available via Consul cluster monitoring, and can be especially helpful during periods of intermittent platform degradation.</p>
<h2 id="what-does-enm-scout-provide">What does ENM Scout provide?</h2>
<p>ENM Scout currently provides the following reports, one per month, served over the web:</p>
<ul>
<li>An events log generated from the HA workflows.
<ul>
<li>One event per VM recovery attempt, with detailed information about each.</li>
<li>Time-synchronized to UTC across all deployments.</li>
<li>Updated every 10 minutes.</li>
<li>Output available in two formats:
<ul>
<li>CSV (for importing into Excel)</li>
<li>JSON (for using as input to Perl and Python scripts)</li>
</ul>
</li>
</ul>
</li>
<li>An events log showing VM Consul status.
<ul>
<li>Generated from data provided by the enm-viz monitoring Prometheus agents.</li>
<li>Updated every 2 minutes.</li>
<li>Output also available in CSV and JSON, as above.</li>
</ul>
</li>
<li>An HA workflow analysis report per month.
<ul>
<li>Shows several useful histograms which can be used to analyze HA workflow activity and performance.</li>
<li>Time-synchronized to UTC across all deployments.</li>
<li>Updated every 10 minutes.</li>
</ul>
</li>
</ul>
<p>Also, logging into the node that runs ENM Scout will give the user access to full UTC time-synced logs for all production tenants, which can be used for further analysis, as well a command line utility called <code>ha-state.py</code> which can be run by hand to analyze and provide insight into any subset of those jBoss logs.</p>
<h2 id="whats-an-ha-event">What’s an “HA event”?</h2>
<p>When instability is detected in an ENM deployment, which can happen for a variety of reasons, the VNF-LAF lifecycle management engine tries to restore stability by deleting and recreating the VMs that host ENM’s application components. From a high level, the operation looks like this:</p>
<ol>
<li>One or more VMs fail some of their health checks that run on the node level, or the VM itself goes into “status left” in the Consul cluster.</li>
<li>This is noticed by a component called the SAM (simple availability manager), which raises a monitoring alert for the VMs.</li>
<li>The VNF-LAF picks up the monitoring alert and triggers a workflow called HighAvailabilityWorkflow, or HA workflow, for this VM or group of VMs.</li>
<li>The HA workflow goes through a series of steps in an attempt to recover the VMs in question, then checks to see if the VMs have returned to Consul.</li>
</ol>
<p>When ENM Scout logs an HA event, what this means is that it looked in the VNF logs and noticed that an HA workflow fired, and as a result, it creates one “HA<br>
event” per VM that VNF-LAF is attempting to recover. This is an important detail: one HA workflow run can trigger multiple HA events to be logged, one per VM.</p>
<h2 id="what-causes-the-ha-workflow-to-fire">What causes the HA workflow to fire?</h2>
<p>Anything that causes a node to fail one of its own health checks or drop out of Consul for any length of time (even a few seconds) can trigger an HA workflow. Surrounding circumstances can include, but are certainly not limited to:</p>
<ul>
<li>Underlying OpenStack platform issues:
<ul>
<li>Certain types of network connectivity problems:
<ul>
<li>on the network used for VM to VM communication</li>
<li>on the network used to access network-based central storage</li>
</ul>
</li>
<li>Central storage slowness or timeouts:
<ul>
<li>storage rebalancing</li>
<li>hard drive failure</li>
<li>raid controller failure</li>
</ul>
</li>
</ul>
</li>
<li>VM application issues</li>
<li>VM infrastructure issues:
<ul>
<li>full virtual disk partitions</li>
<li>high CPU utilization</li>
<li>running out of memory due to memory leaks</li>
</ul>
</li>
</ul>
<h2 id="what-are-the-limitations-of-the-ha-workflow">What are the limitations of the HA workflow?</h2>
<p>Interesting situations which will not trigger HA workflow events are:</p>
<ul>
<li>Network connectivity issues on the path from ENM to the customer.</li>
<li>Central NFS issues inside a deployment.</li>
</ul>
<p>There are likely other cases we haven’t yet knowingly experienced which affect application functionality or performance but aren’t caught by the node-level health checks and/or do not cause a VM to leave the Consul cluster.</p>
<p>Thus, it’s important to note that HA events, even when added to the Consul events, do not tell the whole story about application availability and performance. A lot more could be learned by implementing real-time monitoring for ENM that focuses on core application functionality and performance metrics.</p>
<h2 id="what-are-the-steps-taken-by-an-ha-workflow">What are the steps taken by an HA workflow?</h2>
<p>As of October 2019, HA workflow steps are roughly as follows:</p>
<ol>
<li>HA workflow start</li>
<li>Look up VM by name using OpenStack Nova API and pull all info about it</li>
<li>Pull a list of stack names to stack urls</li>
<li>Use something from that query (IP?) to identify the corresponding Heat stack</li>
<li>Acquire lock on some part of the Heat stack (outer stack?)</li>
<li>Make a Nova request which goes to the compute node to stop the VM if it’s running</li>
<li>Send a delete request to Heat for the VM, in some cases</li>
<li>Mark some part of the Heat stack unhealthy… either the inner stack, or the VM resource</li>
<li>Send an update request to the Heat stack, causing components marked unhealthy to be recreated</li>
<li>Wait for VMs to come back up and register in Consul</li>
<li>If a VM comes back: “sucessfully restored” and status “cleared” for the FM alarm for the VM</li>
<li>If the HA workflow waits for 5.5 minutes and a VM didn’t come back, “updating severity to critical of FM alarm”, then “retrying HA workflow for VMs” and the process restarts.</li>
</ol>
<p>IMPORTANT NOTE: there is NO log message when a workflow ends, so the “recovered time” in an HA event is the time of the “successfully restored” message seen in the jBoss logs.</p>
<h2 id="what-does-an-ha-event-look-like">What does an HA event look like?</h2>
<p>One HA event in JSON format looks like this:</p>
<pre><code>{
  "deployment": "sprint",
  "vm": "bmasenm01-medrouter-1",
  "ha_id": "1569998875591",
  "start_time": "2019-10-02T06:47:55.601",
  "recovered_time": "2019-10-02T06:50:45.747",
  "attempts": 1
}
</code></pre>
<p>Each HA event contains the following attributes:</p>
<ol>
<li>The name of the deployment, also known as the customer name or tenant name. These names are gleaned from the “deployments” configuration file, from a mapping between the VNF-LAF services node IP and this name. The customer name does not actually show up anywhere in the VNF-LAF logs.</li>
<li>The name of the VM.</li>
<li>The HA workflow ID, which can be helpful when looking for this HA workflow event in the logs. Many, but not all, of the log lines for this particular workflow execution contain this ID.</li>
<li>The start time of this HA workflow, in UTC.</li>
<li>The recovered or end time of this HA workflow, in UTC. This value might be null in cases where the workflow is either currently in progress and hasn’t<br>
finished recovering the VM yet, or where the workflow gave up on recovery the VM for any reason.</li>
<li>A number of attempts to recover this particular VM made by this particular workflow, which are calculated by counting the number of times that resources are marked unhealthy in the OpenStack Heat stacks by the workflow.</li>
</ol>
<h2 id="whats-a-consul-event">What’s a “Consul event”?</h2>
<p>Each ENM deployment uses Consul to cluster the VMs together, which serves at least two purposes that we know of:</p>
<ol>
<li>Consul is used as a service registry, which VMs use to figure out how to contact other VMs in its deployment.</li>
<li>Consul is also used by the Simple Availability Manager and the VNF-LAF to monitor VM presence in the cluster, as sort of a shorthand for whether or not the VM should be considered “up”.</li>
</ol>
<p>Each VM has a “status” in Consul, which is actually its Serf member status. The status can be one of the following, as seen in the Serf source code:</p>
<pre><code>const (
    StatusNone MemberStatus = iota
    StatusAlive
    StatusLeaving
    StatusLeft
    StatusFailed
)
</code></pre>
<p>The consulProm agent which is a part of enm-viz collects and presents this data on a per-deployment basis, collecting it by SSHing into the services nodes.</p>
<p>Each time the consul-event-generator runs, it connects to the consulProm agents and collects this data and stores it in a state file. Whenever a VM changes status from the last time it was seen, consul-event-generator writes a Consul event to its logs.</p>
<h2 id="what-does-a-consul-event-look-like">What does a Consul event look like?</h2>
<p>A Consul event in JSON format looks like this:</p>
<pre><code>{
  "event_time": "2019-10-02T06:47:55.601"
  "deployment": "sprint",
  "vm": "bmasenm01-medrouter-1",
  "message": "transition from status Alive to Left"
}
</code></pre>
<p>Each event contains the following attributes:</p>
<ol>
<li>The time this event was noticed. Note: this is the run time of the consul-events-generator and not necessarily the time that this change actually occurred.</li>
<li>The name of the deployment, gleaned from the consulProm configuration file.</li>
<li>The VM name.</li>
<li>A message describing the event.</li>
</ol>
<h2 id="what-are-the-limitations-of-consul-events">What are the limitations of Consul events?</h2>
<p>The Consul events can only tell you that a particular VM changed state in Consul. There are a large number of application availability and performance issues that will not necessarily cause VMs to leave Consul, and conversely, there are circumstances that can cause a node to leave Consul (such as Consul application issues) even though the application is doing fine.</p>
<p>At this time, the events generator only reports on state changes from moment to moment; it isn’t qualified to make a judgment of whether a particular event<br>
means that something is broken. In order to figure out the meaning and importance of the events, a human will need to read through and judge them.</p>
<p>It would be possible to use these events as input for something like an alerting or reporting tool, which could attempt to make judgments for each event using context (grouping events together) and/or rule-based policy.</p>
<h2 id="what-are-the-components-of-enm-scout">What are the components of ENM Scout?</h2>
<p>ENM Scout is made of 6 components, written in Python:</p>
<ul>
<li><code>vnflaf-log-slurper.py</code>
<ul>
<li>Downloads and synchronizes jBoss logs from all production VNF-LAF services nodes, writing them out to disk in per-deployment subdirectories.</li>
</ul>
</li>
<li><code>vnflaf-events-generator.py</code>
<ul>
<li>Parses through jBoss logs to generate events for each HA recovery attempt, one event per VM. Outputs in CSV and JSON.</li>
</ul>
</li>
<li><code>ha-state.py</code>
<ul>
<li>Analyzes a given list of jBoss logs and provides useful histograms showing HA workflow events and retries for each VM, which can be used for fast and in-depth troubleshooting.</li>
</ul>
</li>
<li><code>vnflaf-reporter.py</code>
<ul>
<li>Runs the log slurper and then the events-generator and ha-state reports, in the right order. Meant to be run periodically from cron.</li>
</ul>
</li>
<li><code>consul-events-generator.py</code>
<ul>
<li>Generates VM state events from data provided by the enm-viz monitoring Prometheus agents.</li>
</ul>
</li>
<li><code>enmscout.py</code>
<ul>
<li>Provides common functions used in the rest of the code.</li>
</ul>
</li>
</ul>
<h2 id="how-can-enm-scout-be-installed">How can ENM Scout be installed?</h2>
<p>The installation is very flexible; the software suite is configured using a global configuration file. The test environment is installed this way:</p>
<ul>
<li>
<p>Copy the python code to <code>/opt/enmscout/bin</code></p>
</li>
<li>
<p>Copy the configuration files to <code>/opt/enmscout/etc</code></p>
</li>
<li>
<p>Check the configuration files to make sure that they make sense for your environment.</p>
</li>
<li>
<p>Make a system account for enmscout.</p>
</li>
</ul>
<pre><code>sudo adduser --system enmscout --group
</code></pre>
<ul>
<li>Make directories that enmscout will use, and chown them.</li>
</ul>
<pre><code>for dir in /run/lock/enmscout /var/log/vnflaf /var/log/enmscout /var/tmp/enmscout /var/www/html
do
    sudo mkdir -p "${dir}"
    sudo chown -R enmscout:enmscout "${dir}"
done
</code></pre>
<ul>
<li>
<p>Acquire the SSH keys that will be required to contact each deployment (stored in various locations on the genie-utility VM), and put them in <code>/opt/enmscout/etc/keys</code></p>
</li>
<li>
<p>Make sure the enmscout user is the only one who can read that directory, too</p>
</li>
</ul>
<pre><code>sudo chown -R enmscout:enmscout /opt/enmscout/etc/keys
sudo chmod 700 /opt/enmscout/etc/keys
</code></pre>
<ul>
<li>Install a crontab for the enmscout user that looks like this:</li>
</ul>
<pre><code>*/10 * * * * /opt/enmscout/bin/vnflaf-reporter.py &gt;/dev/null
*/2 * * * * /opt/enmscout/bin/consul-events-generator.py &gt;/dev/null
</code></pre>
<ul>
<li>Tune the timing of those enmscout cronjobs based on your needs and the speed of the executions.</li>
</ul>
<h2 id="what-are-the-current-known-caveats">What are the current known caveats?</h2>
<ul>
<li>
<p>In order to contact the deployments, this code uses the SSH keys, rather than a password. If those keys change, someone will need to copy the new ones for this tool to use. This is not ideal, and should be automated.</p>
</li>
<li>
<p>The software currently has to be installed manually. It could use an installer.</p>
</li>
<li>
<p>Certain components of this software, especially the HA log copying and UTC time synchronization, might require further optimization in order to scale<br>
up further. One example: It may make more sense to change the VNF-LAF nodes so that they log continuously to a central log server using syslog, and mark them with the UTC time as they arrive.</p>
</li>
<li>
<p>It is not yet known what connectivity will be like between datacenters, and as such, it’s not certain whether it will be necessary to run multiple<br>
instances of this app, one per datacenter, or whether it will be possible or optimal to run one central instance that collects data from all datacenters.</p>
</li>
</ul>
<h2 id="where-can-i-go-for-more-information">Where can I go for more information?</h2>
<ul>
<li>There is another document showing how to use <code>ha-state.py</code> in great detail.</li>
<li>There are a lot of code comments strewn throughout the code which can be used to figure out what’s going on and why.</li>
<li>There are log files written to disk by each component which can also help figure out what’s going on, especially if things don’t seem to be working properly.</li>
</ul>

    </div>
  </div>
</body>

</html>
